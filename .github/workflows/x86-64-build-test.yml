name: x86-64 build and test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: install rust nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src, llvm-tools-preview

    - name: install qemu
      run: sudo apt-get update && sudo apt-get install -y qemu-system-x86

    - name: build kernel
      run: cargo build --bin jericho_os --release

    - name: check binary size
      run: |
        BOOT_IMAGE=$(find target/x86_64-unknown-none/release/build -name "boot-bios.img" 2>/dev/null | head -1)
        if [ -z "$BOOT_IMAGE" ]; then
          echo "boot image not found"
          exit 1
        fi

        SIZE=$(stat -c%s "$BOOT_IMAGE")
        SIZE_MB=$((SIZE / 1024 / 1024))
        echo "boot image: ${SIZE_MB}mb"

        if [ $SIZE -gt 10485760 ]; then
          echo "too big (> 10mb)"
          exit 1
        fi

    - name: run demos
      timeout-minutes: 1
      run: |
        chmod +x demo_x86.sh
        ./demo_x86.sh > output.txt 2>&1 || true
        cat output.txt

    - name: validate results
      run: |
        for i in 1 2 3 4 5; do
          if ! grep -q "Demo $i" output.txt; then
            echo "demo $i failed"
            cat output.txt
            exit 1
          fi
          echo "demo $i passed"
        done

        echo "all demos passed"

    - name: save artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: x86-64-output
        path: |
          output.txt
          target/x86_64-unknown-none/release/build/*/out/boot-*.img
        retention-days: 7
