name: arm64 build and test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-24.04-arm  # native arm64 hardware

    steps:
    - uses: actions/checkout@v4

    - name: install rust nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rust-src, llvm-tools-preview

    - name: install qemu
      run: sudo apt-get update && sudo apt-get install -y qemu-system-aarch64

    - name: build kernel
      run: |
        chmod +x build_arm64.sh
        ./build_arm64.sh

    - name: check binary size
      run: |
        SIZE=$(stat -c%s target/aarch64/kernel_arm64.bin)
        SIZE_KB=$((SIZE / 1024))
        SIZE_MB=$((SIZE / 1024 / 1024))
        echo "binary: ${SIZE_KB}kb (${SIZE_MB}mb)"

        if [ $SIZE -gt 10485760 ]; then
          echo "too big (> 10mb)"
          exit 1
        fi

    - name: run kernel in qemu
      timeout-minutes: 1
      run: |
        chmod +x run_arm64.sh
        timeout 8s ./run_arm64.sh > output.txt 2>&1 || true
        cat output.txt

    - name: validate demos
      run: |
        if ! grep -q "JerichoOS v0.1.0 - AArch64" output.txt; then
          echo "boot failed"
          exit 1
        fi

        for i in 1 2 3 4 5; do
          if ! grep -q "DEMO $i.*COMPLETE" output.txt; then
            echo "demo $i failed"
            cat output.txt
            exit 1
          fi
          echo "demo $i passed"
        done

        if grep -q "IPC-DENIED.*no IPC_SEND capability" output.txt; then
          echo "capability system working"
        fi

        echo "all demos passed"

    - name: save artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: arm64-output
        path: |
          output.txt
          target/aarch64/kernel_arm64.bin
        retention-days: 7
